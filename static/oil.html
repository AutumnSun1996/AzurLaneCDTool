<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>碧蓝航线辅助工具-经验油耗比计算器</title>
    <link rel="stylesheet" href="https://bossanova.uk/jspreadsheet/v4/jexcel.css" type="text/css" />
    <link rel="stylesheet" href="https://jsuites.net/v4/jsuites.css" type="text/css" />
    <style>
        .jexcel>tbody>tr>td.readonly {
            color: black;
        }

        #records select {
            width: 200px;
        }
    </style>
</head>

<body>
    <h1>碧蓝航线辅助工具-经验油耗比计算器</h1>
    <div id="records"></div>
    <br>
    自定义名称:
    <br>
    <div id="headers"></div>
    <br>
    自定义战斗内容:
    <br>
    <div id="fight"></div>
    <br>
    自定义其他收益:
    <br>
    <div id="other"></div>
    <br>
    自定义队伍和经验收益:
    <br>
    <div id="fleet"></div>
    <br>
    <div id="output"></div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://bossanova.uk/jspreadsheet/v4/jexcel.js"></script>
    <script src="https://jsuites.net/v4/jsuites.js"></script>
    <script src="js/storage.js?v=4"></script>
    <script>
        var manager, headerSheet, otherSheet, fleetSheet, fightSheet;
        function onChange() {
            let cur = manager.current();
            cur.headers[0] = cur.name;
            headerSheet.setData([cur.headers]);
            otherSheet.setData(cur.other);
            fleetSheet.setData(cur.fleet);
            fleetSheet.resetSelection();
            fightSheet.setData(cur.fight);
            update();
        }
        manager = initRecordsManager('SheetData', '#records', function () {
            return {
                name: '测试',
                headers: ['测试', '计算经验1', '计算经验2', '计算经验3'],
                fleet: [
                    ['道中', '', '', '', '', ''],
                    ['道中', '', '', '', '', ''],
                    ['道中', '', '', '', '', ''],
                    ['道中', '', '', '', '', ''],
                    ['道中', '', '', '', '', ''],
                    ['道中', '', '', '', '', ''],
                    ['潜艇', '', '', '', '', ''],
                    ['潜艇', '', '', '', '', ''],
                    ['潜艇', '', '', '', '', ''],
                    ['BOSS', '', '', '', '', ''],
                    ['BOSS', '', '', '', '', ''],
                    ['BOSS', '', '', '', '', ''],
                    ['BOSS', '', '', '', '', ''],
                    ['BOSS', '', '', '', '', ''],
                    ['BOSS', '', '', '', '', ''],
                ],
                fight: [
                    [3, 100, 1, 0],
                    [3, 100, 1, 1],
                ],
                other: [],
            }
        }, onChange);
        function cancel() {
            return false;
        }
        function callHideIndex(el, obj) {
            obj.hideIndex();
        }
        var cur = manager.current();
        headerSheet = $('#headers').jspreadsheet({
            data: [cur.headers],
            columns: [
                {
                    type: 'text',
                    title: '名称',
                    width: 200,
                },
                {
                    type: 'text',
                    title: '经验1名称',
                },
                {
                    type: 'text',
                    title: '经验2名称',
                },
                {
                    type: 'text',
                    title: '经验3名称',
                },
            ],
            defaultColWidth: 100,
            allowInsertRow: false,
            allowDeleteRow: false,
            // Allow new columns
            allowInsertColumn: false,
            // Allow column delete
            allowDeleteColumn: false,
            columnSorting: false,
            onload: callHideIndex,
            onafterchanges: function () {
                var cur = manager.current();
                cur.headers = headerSheet.getData()[0];
                for (let i of [1, 2, 3]) {
                    fleetSheet.setHeader(i + 2, cur.headers[i] || '-');
                }
                if (cur.headers[0] !== cur.name) {
                    cur.name = cur.headers[0];
                    manager.rebuildOptions();
                }
                update();
            }
        });
        otherSheet = $('#other').jspreadsheet({
            data: cur.other,
            columns: [
                {
                    type: 'numeric',
                    title: '数值',
                },
                {
                    type: 'text',
                    title: '名称',
                },
            ],
            defaultColWidth: 100,
            allowInsertRow: true,
            allowInsertRow: true,
            // Allow new columns
            allowInsertColumn: false,
            // Allow column delete
            allowDeleteColumn: false,
            columnSorting: false,
            onafterchanges: function () {
                update();
            },
            minDimensions: [2, 2]
        });

        fleetSheet = $('#fleet').jspreadsheet({
            data: cur.fleet,
            columns: [
                {
                    type: 'text',
                    title: '类型',
                    readOnly: true,
                    width: 120,
                },
                {
                    type: 'numeric',
                    title: '油耗',
                    width: 80,
                },
                {
                    type: 'numeric',
                    title: 'MVP优先级',
                    width: 100
                },
                {
                    type: 'checkbox',
                    title: '经验1',
                    width: 80
                },
                {
                    type: 'checkbox',
                    title: '经验2',
                    width: 80
                },
                {
                    type: 'checkbox',
                    title: '经验3',
                    width: 80
                },
            ],
            mergeCells: {
                A1: [1, 6],
                A7: [1, 3],
                A10: [1, 6],
            },
            contextMenu: cancel,
            allowInsertRow: false,
            allowDeleteRow: false,
            // Allow new columns
            allowInsertColumn: false,
            // Allow column delete
            allowDeleteColumn: false,
            columnSorting: false,
            onload: callHideIndex,
            onafterchanges: function () {
                console.log('update');
                update();
            }
        });
        headerSheet.onafterchanges();
        fleetSheet.resetSelection()

        fightSheet = $('#fight').jspreadsheet({
            data: cur.fight,
            columns: [
                {
                    type: 'numeric',
                    title: '次数',
                    width: 120,
                },
                {
                    type: 'numeric',
                    title: '经验',
                    width: 80,
                },
                {
                    type: 'numeric',
                    title: '潜艇覆盖几率',
                    width: 150
                },
                {
                    type: 'checkbox',
                    title: '使用Boss队',
                    width: 100
                },
                {
                    type: 'text',
                    title: '备注',
                    width: 100
                },
            ],
            // Allow new columns
            allowInsertColumn: false,
            // Allow column delete
            allowDeleteColumn: false,
            columnSorting: false,
            onafterchanges: function () {
                console.log('update');
                update();
            }
        });
        headerSheet.onafterchanges();

        function loadFleet(rows) {
            let res = [];
            for (let row of rows) {
                let oil = parseInt(row[1]);
                if (!oil) {
                    continue;
                }
                res.push({
                    oil: oil,
                    mvp: parseFloat(row[2]) || 0,
                    gains: row.slice(3).map(Boolean),
                });
            }
            console.log('loadFleet', res);
            return res;
        }

        function update() {
            let cur = manager.current();
            let bossInfo = null;
            let fights = [];
            for (let row of cur.fight) {
                if (!row[1]) {
                    continue;
                }
                let cnt = row[0] || 1;
                let gain = parseInt(row[1]);
                for (let i = 0; i < cnt; ++i) {
                    fights.push({
                        exp: gain,
                        subChance: parseFloat(row[2]),
                        useBoss: row[3] ? 1 : 0,
                    });
                }
            }

            let fleetRoute = loadFleet(cur.fleet.slice(0, 6));
            let fleetSub = loadFleet(cur.fleet.slice(6, 9));
            let fleetBoss = loadFleet(cur.fleet.slice(9));


            let subExp = [];
            let submarineFightCount = Math.min(fights.length, fleetSub.length * 2);
            console.log('潜艇战斗次数', submarineFightCount);

            let totalExp = [0, 0, 0];
            let totalOil = 10;
            for (let [idx, f] of fights.entries()) {
                console.log('fight', idx, f);
                let recs = [[], [], []];
                let mvpIdx = 0;
                let mvpWeight = 0;
                if (!f.useBoss) {
                    for (let s of fleetRoute) {
                        if (mvpWeight < s.mvp) {
                            mvpIdx = recs[0].length;
                            mvpWeight = s.mvp;
                            console.log('设置MVP-道中', mvpIdx);
                        }
                        totalOil += s.oil;
                        for (let i of [0, 1, 2]) {
                            recs[i].push(s.gains[i] * 1.2 * f.exp);
                        }
                    }
                } else {
                    for (let s of fleetBoss) {
                        if (mvpWeight < s.mvp) {
                            mvpIdx = recs[0].length;
                            mvpWeight = s.mvp;
                            console.log('设置MVP-Boss', mvpIdx);
                        }
                        totalOil += s.oil;
                        for (let i of [0, 1, 2]) {
                            recs[i].push(s.gains[i] * 1.2 * f.exp);
                        }
                    }
                }
                if (idx < submarineFightCount) {
                    for (let s of fleetSub) {
                        console.log(mvpWeight, s);
                        if (mvpWeight < s.mvp) {
                            mvpIdx = recs.length;
                            mvpWeight = s.mvp;
                            console.log('设置MVP-潜艇', mvpIdx);
                        }
                        totalOil += s.oil;
                        for (let i of [0, 1, 2]) {
                            recs[i].push(s.gains[i] * 1.2 * f.exp);
                        }
                    }
                }
                // MVP 2倍经验
                for (let i of [0, 1, 2]) {
                    recs[i][mvpIdx] = recs[i][mvpIdx] * 2;
                    for (let e of recs[i]) {
                        totalExp[i] += e;
                    }
                }
                console.log('经验获取', idx, recs);
            }
            $('#output').html('');
            $('#output').append(`油耗: ${totalOil}<br>`);
            let extra = false;
            for (let row of cur.other) {
                let cnt = parseFloat(row[0]);
                if (cnt) {
                    $('#output').append(`<br>获取: ${row[0]} ${row[1]}, 油耗比${(cnt / totalOil).toFixed(3)}`)
                    extra = true;
                }
            }
            if (extra) {
                $('#output').append('<br>');
            }

            let oilRatio = totalExp.map((v) => (v / totalOil).toFixed(3));
            for (let i of [0, 1, 2]) {
                if (!totalExp[i]) {
                    continue;
                }
                $('#output').append('<br>' + cur.headers[i + 1] + '<br>');
                $('#output').append(`加成后的总经验: ${totalExp[i]}<br>`);
                $('#output').append(`经验/油耗: ${oilRatio[i]}<br>`);
            }
        }
        onChange();
    </script>

</body>

</html>