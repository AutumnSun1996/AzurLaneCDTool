<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>碧蓝航线CD计算器-Alpha</title>
    <style>
        input {
            width: 80px;
        }

        input.name {
            width: 100px;
        }
    </style>
</head>

<body>
    <h1>碧蓝航线CD计算器-Alpha</h1>
    <button onclick="saveRecord()">保存配置</button>
    <button onclick="deleteRecord()">删除配置</button>
    <select name="records" id="records" onchange="loadRecord()"></select>
    <button onclick="resetData()">重置本地缓存</button>

    <div id="extra-reload-inc">
        <label for="tech-inc-bb">舰队科技-战列装填加成</label>
        <input type="number" name="tech-inc-bb" id="tech-inc-bb" value="0" min="0">
        <label for="tech-inc-cv">舰队科技-航母装填加成</label>
        <input type="number" name="tech-inc-cv" id="tech-inc-cv" value="0" min="0">
        <br>
        <label for="cat-inc-bb">指挥猫-战列装填加成</label>
        <input type="number" name="cat-inc-bb" id="cat-inc-bb" value="0" min="0">
        <label for="cat-inc-cv">指挥猫-航母装填加成</label>
        <input type="number" name="cat-inc-cv" id="cat-inc-cv" value="0" min="0">
    </div>

    <div id="inputs"></div>
    <div id="buff"></div>
    <div id="time">
        <label for="max-duration">战斗时间</label>
        <input type="number" name="max-duration" id="max-duration">s
        &nbsp;
        <label for="time-inv">按剩余时间显示</label>
        <input type="checkbox" name="time-inv" id="time-inv">
    </div>
    <div id="chart" style="width: auto; height: 600px;"></div>
</body>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.1.2/dist/echarts.min.js"
    integrity="sha256-TI0rIaxop+pDlHNVI6kDCFvmpxNYUnVH/SMjknZ/W0Y=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script src="js/render.js"></script>
<script>
    const STORE_KEY = 'AzurLaneCDTool-CacheData';
    var data;
    function updateShipDataDom() {
        $('#inputs').html('');
        for (var [id, ship] of data.shipChartData.entries()) {
            console.log(id, ship)
            ship.id = `ship-${id}`;
            $('#inputs').append(`
        <div id="ship-${id}" class="shipinfo">
            <select class="ship-input type" name="type-${id}" id="type-${id}">
                <option value="null">无</option>
                <option value="CV">航母</option>
                <option value="BB">战列</option>
            </select>
            <span class="num-inputs">
                <label for="name-${id}">名称</label>
                <input class="ship-input name" type="text" name="name-${id}" id="name-${id}">
                <label for="cd-${id}">面标CD</label>
                <input class="ship-input cd" type="number" name="cd-${id}" id="cd-${id}" min="0" step="any">
                <label for="reload-${id}">面标装填</label>
                <input class="ship-input reload" type="number" name="reload-${id}" id="reload-${id}" min="0">
                <label for="reloadbuff-${id}">额外装填(%)</label>
                <input class="ship-input reloadbuff" type="number" name="reloadbuff-${id}" id="reloadbuff-${id}" min="0">
                <label for="firstbuff-${id}">首轮射速加成(%)</label>
                <input class="ship-input firstbuff" type="number" name="firstbuff-${id}" id="firstbuff-${id}" min="0" max="100">
                <label for="buff-${id}">射速加成(%)</label>
                <input class="ship-input buff" type="number" name="buff-${id}" id="buff-${id}" max="100">
            </span>
            <br>
        </div>
        `);
            var $ship = $('#ship-' + id);
            $ship.find('.type').val(ship.type);
            $ship.find('.name').val(ship.name);
            $ship.find('.reload').val(ship.reload);
            $ship.find('.cd').val(ship.ts.cd);
            $ship.find('.reloadbuff').val(ship.reloadBuff || 0);
            $ship.find('.firstbuff').val(ship.ts.firstBuff || 0);
            $ship.find('.buff').val(ship.ts.buff || 0);

            if (ship.type == 'null') {
                $ship.find('.num-inputs .ship-input').prop('disabled', 'disabled');
            }
        }
        $('#inputs .ship-input').on('change', updateShipData);
    }

    function updateShipData() {
        console.log('updateShipData');
        data.shipChartData = [];
        for (var ship of $('.shipinfo')) {
            if ($(ship).find('.type').val() == 'null') {
                $(ship).find('.num-inputs .ship-input').prop('disabled', 'disabled');
            } else {
                $(ship).find('.num-inputs .ship-input').prop('disabled', null);
            }
            data.shipChartData.push({
                name: $(ship).find('.name').val(),
                type: $(ship).find('.type').val(),
                reload: $(ship).find('.reload').val(),
                reloadBuff: $(ship).find('.reloadbuff').val(),
                ts: {
                    cd: parseFloat($(ship).find('input.cd').val()),
                    buff: parseInt($(ship).find('input.buff').val()),
                    firstBuff: parseInt($(ship).find('input.firstbuff').val()),
                }
            })
        }
        saveData(data);
        window.setChartOption(data);
    }

    function bindCheckbox(obj, key, target) {
        var $dom = $(target);
        if (obj[key]) {
            $dom.prop('checked', 'checked');
        } else {
            $dom.prop('checked', null);
        }
        $dom.on('change', (evt) => {
            obj[key] = evt.target.checked;
            saveData(data);
            setChartOption(data);
        });
    }
    function bindInput(obj, key, target) {
        var $dom = $(target);
        $dom.val(obj[key]);
        $dom.on('change', (evt) => {
            console.log('on change', $dom, $dom.val())
            obj[key] = $dom.val();
            saveData(data);
            setChartOption(data);
        });
    }
    function updateRecordOptions() {
        var dom = $('#records');
        dom.html('');
        var selected;
        for (var allkey in data.records) {
            dom.append(`<option value="${allkey}">${allkey}</option>`)
        }
    }
    function saveRecord(save = true) {
        var key = [];
        for (let ship of data.shipChartData) {
            if (ship.type != 'null') {
                key.push(ship.name);
            }
        }
        key = key.join(',');
        console.log('saved', key);
        if (save) {
            data.records[key] = data.shipChartData;
            saveData(data);
        }
        updateRecordOptions();
        $('#records option').prop('selected', null);
        $(`#records option[value="${key}"]`).prop('selected', 'selected');
    }
    function deleteRecord() {
        var key = $('#records').val();
        if (!data.records[key]) {
            return;
        }
        delete data.records[key];
        saveData(data);
        updateRecordOptions();
    }
    function loadRecord() {
        var key = $('#records').val();
        if (!data.records[key]) {
            return;
        }
        data.shipChartData = data.records[key];
        saveData(data);
        setChartOption(data);
        updateShipDataDom();
    }

    function saveData(data) {
        localStorage.setItem(STORE_KEY, JSON.stringify(data));
    }
    var buffData = {};
    async function loadBuffData() {
        var resp = await fetch('data/buff.json');
        buffData = await resp.json();
        var buffDom = document.getElementById('buff');
        for (var key in buffData) {
            var item = buffData[key];
            item.id = key;
            buffDom.innerHTML += `<label for="${key}">${item.name}</label>`;
            buffDom.innerHTML += `<input type="checkbox" name="${key}" id="${key}" onchange="updateBuffData(this)" />`;
        }
        for (var item of data.buffChartData) {
            document.getElementById(item.id).checked = true;
        }
    }

    function updateBuffData(obj) {
        if (obj.checked) {
            var item = buffData[obj.id]
            console.log(item);
            if (!!item.exclude) {
                for (var key of item.exclude) {
                    var eitem = document.getElementById(key);
                    eitem.checked = false;
                }
            }
        }
        data.buffChartData = [];
        for (var key in buffData) {
            if (document.getElementById(key).checked) {
                data.buffChartData.push(buffData[key]);
            }
        }
        saveData(data);
        window.setChartOption(data);
    }
    function initAll() {
        data = JSON.parse(localStorage.getItem(STORE_KEY));
        console.log('LoadData', data);
        updateShipDataDom();
        updateRecordOptions();
        saveRecord(false);
        loadBuffData();
        window.setChartOption(data);

        bindCheckbox(data.config, 'showTimeAsLeft', '#time-inv');
        bindInput(data.config, 'maxDuration', '#max-duration');

        bindInput(data.extraReload, 'tech-BB', '#tech-inc-bb');
        bindInput(data.extraReload, 'tech-CV', '#tech-inc-cv');

        bindInput(data.extraReload, 'cat-BB', '#cat-inc-bb');
        bindInput(data.extraReload, 'cat-CV', '#cat-inc-cv');
    }
    function resetData() {
        console.log("RESET Data");
        data = {
            extraReload: {},
            shipChartData: [{ type: 'null', ts: {} }, { type: 'null', ts: {} }, { type: 'null', ts: {} }],
            buffChartData: [],
            config: {
                maxDuration: 180
            },
            records: {},
        };
        saveData(data);
    }
    try {
        initAll();
    } catch (e) {
        resetData();
        initAll();
    }
</script>

</html>